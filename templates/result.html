<?php
ini_set('display_errors', 1);
error_reporting(E_ALL);

session_start();
include 'db.php';

$trustScore = null;
$shopping_url = "";
$scoreColor = "";
$isLegit = "";
$ratingSubmitted = false;

// Logged-in user
$user_id = $_SESSION['user_id'] ?? null;

// ✅ NEW — Your ML API endpoint
$ML_API = "http://127.0.0.1:5000/api/predict";
// Change to your domain API when uploaded to hosting
// Example: $ML_API = "https://smellscam.com/insta_scam_detector1/api/predict";

// ================================================
// ✅ SCAN LOGIC (REPLACED RANDOM TRUST SCORE)
// ================================================
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST["shopping_url"])) {

    $shopping_url = htmlspecialchars($_POST["shopping_url"]);

    // ✅ NEW — Call Python ML API
    $postData = http_build_query(["url" => $shopping_url]);
    $options = [
        "http" => [
            "header"  => "Content-Type: application/x-www-form-urlencoded\r\n",
            "method"  => "POST",
            "content" => $postData
        ]
    ];
    $context = stream_context_create($options);

    $apiResponse = @file_get_contents($ML_API, false, $context);

    if ($apiResponse === FALSE) {
        die("❌ Cannot connect to ML API. Start your Flask server.");
    }

    $apiData = json_decode($apiResponse, true);

    // ✅ Extract values from Python API
    $trustScore = $apiData["trust_score"];
    $prediction = $apiData["prediction"];  // LEGITIMATE / SUSPICIOUS / PHISHING

    // ✅ Assign color + message
    if ($prediction === "LEGITIMATE") {
        $scoreColor = "#28a745";
        $isLegit = "✅ This website looks legit.";
    } elseif ($prediction === "SUSPICIOUS") {
        $scoreColor = "#ffc107";
        $isLegit = "⚠️ This website seems suspicious. Be careful.";
    } else {
        $scoreColor = "#dc3545";
        $isLegit = "❌ WARNING! This site looks like phishing!";
    }

    // ✅ SAVE into database
    try {
        $stmt = $conn->prepare("INSERT INTO scan_results (user_id, shopping_url, trust_score)
                                VALUES (:user_id, :shopping_url, :trust_score)");
        $stmt->execute([
            'user_id' => $user_id ?: null,
            'shopping_url' => $shopping_url,
            'trust_score' => $trustScore
        ]);
    } catch (PDOException $e) {
        echo "❌ Error saving scan: " . $e->getMessage();
    }

}
// ================================================
// ✅ END SCAN LOGIC
// ================================================


// ============== RATING LOGIC (same as your code) ==============
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST["rating"])) {
    $rating = (int) $_POST["rating"];
    try {
        $stmt = $conn->prepare("INSERT INTO ratings (user_id, rating) VALUES (:user_id, :rating)");
        $stmt->execute([
            'user_id' => $user_id ?: null,
            'rating' => $rating
        ]);
        $ratingSubmitted = true;
    } catch (PDOException $e) {
        echo "❌ Error saving rating: " . $e->getMessage();
    }
}
?>
